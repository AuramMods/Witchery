# Witchery 1.7.10 -> 1.20.1 Porting Plan

## Working Style
- Breadth first first, depth second.
- Prefer creating full vertical skeletons (all systems present, minimal behavior) before polish.
- Check `/Users/cyberpwn/development/workspace/AuramMods/Witchery/PORTING_MEMORY.md` before starting work each session.
- Check `/Users/cyberpwn/development/workspace/AuramMods/Witchery/PORTING_MANIFEST.md` before hunting for source details.

## Current Snapshot (2026-02-09)
- Legacy source inventory completed for blocks, items, fluids, entities, key registries, and bootstrap flow.
- Manifest + durable memory created.
- Phase 1 registry scaffolding is in place and compiling.
- Phase 2 asset skeleton is partially in place:
  - generated placeholder `blockstates`, `models/block`, and `models/item` for registered content.
  - copied legacy textures into modern resource path.
  - normalized resource-location usage to lowercase-safe paths to avoid model parse failures.
  - migrated model texture refs and assets to singular atlas paths (`block`/`item`) for 1.20.1 compatibility.
  - added temporary barrier-based placeholder textures for missing legacy sprite names to eliminate purple-black fallback during scaffolding.
  - completed lowercase filename normalization in `textures/block` + `textures/item` and validated clean model bake log.
  - started targeted 1.7 visual parity fixes for high-priority blocks (`wolftrap`, `icedoor`, `witchlog`, `mindrake`, `wallgen`).
  - updated `icedoor` to use 1.20.1 door model parent chain (`door_*`) and vanilla door-state rotation mapping.
  - replaced simplified `wolftrap` placeholder with geometry based on legacy `ModelBeartrap` dimensions.
  - converted legacy crop family to staged crop parity assets + crop block classes:
    - crop blockstates now use `age=*` variants instead of cube placeholders for `belladonna`, `mandrake`, `artichoke`, `snowbell`, `wormwood`, `wolfsbane`, `garlicplant`.
    - added stage model sets for those crops (`*_stageN`) and switched crop item models to flat generated icons using mature-stage textures.
    - mapped crop max-age behavior in block scaffolding (`4`, `5`, or `7` depending on legacy crop).
  - expanded `witchlog` parity to multi-wood variants via `wood_type` blockstate (`rowan`, `alder`, `hawthorn`) with dedicated alder/hawthorn model sets.
  - switched `wallgen` block model texture from hardcoded iron placeholder to `witchery:block/wallgen` for visual parity testing.
  - replaced major structural cube placeholders with 1.20.1 state-driven models + block classes:
    - stairs family (`stairswoodrowan`, `stairswoodalder`, `stairswoodhawthorn`, `icestairs`, `snowstairs`)
    - slab family (`witchwoodslab`, `iceslab`, `snowslab`)
    - fence/fence gate (`icefence`, `icefencegate`)
    - pressure plates (`icepressureplate`, `snowpressureplate`, `cwoodpressureplate`, `cstonepressureplate`, `csnowpressureplate`)
    - buttons (`cbuttonwood`, `cbuttonstone`)
  - completed broad non-cube model conversion pass for legacy placeholders:
    - plant-like models migrated to `cross`/flat forms (`bramble`, `somniancotton`, `spanishmoss`, `vine`, `web`, `witchsapling`, `lilypad`, `leapinglily`, `cactus`).
    - technical/utility blocks switched off full-cube rendering (`barrier`, `light`, `slurp`, `force`, `brewgas`) with explicit inventory item icons.
    - fluid-family placeholders converted from full cubes to short liquid approximations (`brew`, `brewliquid`, `disease`, `spiritflowing`, `hollowtears`).
    - portal-family placeholders converted to crossed thin-pane portal geometry (`spiritportal`, `tormentportal`).
    - decorative/functional placeholders converted to non-full approximations (`altar`, `kettle`, `spinningwheel`, `statueofworship`, `coffinblock`, `refillingchest`, `mirrorwall`, `infinityegg`, plus machine-family placeholders `clever`, `distillery*`, `fumefunnel*`, `witchesoven*`).
  - fixed broken double-slab item model placeholders:
    - `icedoubleslab`, `snowdoubleslab`, `witchwooddoubleslab` no longer point at `witchery:item/taglockkit`.
  - added horizontal-facing scaffold parity for key machine/decor blocks in code + blockstates:
    - blocks now place with facing state (`north/east/south/west`) instead of static default state.
    - covered IDs: `altar`, `kettle`, `spinningwheel`, `distilleryidle`, `distilleryburning`, `witchesovenidle`, `witchesovenburning`, `fumefunnel`, `filteredfumefunnel`, `coffinblock`, `statueofworship`, `refillingchest`, `leechchest`.
  - added legacy variant-state parity for core wood/bundle families:
    - `witchwood` now uses `wood_type=rowan|alder|hawthorn` with `planks_*` textures.
    - `witchleaves` now uses `wood_type=rowan|alder|hawthorn` with `leaves_*` textures.
    - `witchsapling` now uses `wood_type=rowan|alder|hawthorn` with `sapling_*` textures.
    - `wickerbundle` now uses `bundle_type=plain|bloodied` with `wicker_block_*` textures.
  - added `shadedglass` color-state parity:
    - `shadedglass` and `shadedglass_active` now use `color=...` with 16 legacy color values.
    - generated `shadedglass_<color>` and `shadedglass_active_<color>` model families from legacy `shadedglassoff_*` / `shadedglass_*` textures.
  - remaining `cube_all` block models reduced to 14 intentionally-full placeholders:
    - core placeholders: `bloodedwool`, `icedoubleslab`, `perpetualice`, `pitdirt`, `pitgrass`, `snowdoubleslab`, `tormentstone`, `wallgen`, `witchwooddoubleslab`.
    - intentional variant models (not generic placeholders): `witchwood_rowan`, `witchwood_alder`, `witchwood_hawthorn`, `shadedglass_*`, `shadedglass_active_*`.
  - fluid scaffold parity now includes fluid block + bucket wiring:
    - converted `spiritflowing`, `hollowtears`, `disease`, `brew`, `brewgas`, `brewliquid` from static placeholder blocks to `LiquidBlock` scaffolds backed by Forge fluid registrations.
    - wired legacy bucket items to Forge fluid buckets: `bucketspirit` -> `fluidspirit`, `buckethollowtears` -> `hollowtears`, `bucketbrew` -> `brew`.
    - added fluid-to-block/bucket mapping in `WitcheryFluids` so source/flowing fluids, blocks, and bucket items are linked for world interaction testing.
  - minimal server data-generation scaffold is now present:
    - added `GatherDataEvent` hook and providers for block tags, loot tables, and recipes.
    - current providers are breadth-first placeholders (`legacy_blocks` tag, generic block self-drops, empty recipe migration stub).
  - placeholder spawn-egg coverage added for entity registry breadth:
    - all legacy entity placeholders now get generated `*_spawn_egg` items (via `WitcheryItems` + `WitcheryEntities` maps).
    - spawn eggs are included in the creative-tab aggregate list for quick scaffolding QA.
  - network skeleton scaffolding now mirrors legacy packet surface:
    - added `WitcheryNetwork` `SimpleChannel` bootstrap and registration from mod init path.
    - added normalized packet-intent inventory for all 19 legacy pipeline messages with legacy ID + direction metadata.
    - replaced generic intent transport with typed no-payload packet stubs per legacy message intent, each registered on the channel with direction validation warnings.
    - implemented codec-backed scaffold payloads + handlers for high-priority sync intents:
      - `player_sync` (uuid + sync revision + serialized `WitcheryPlayerData` snapshot)
      - `extended_player_sync` (uuid + initialized + sync revision + serialized `WitcheryPlayerData` snapshot)
      - `partial_extended_player_sync` (uuid + sync revision + serialized `WitcheryPlayerData` snapshot)
    - expanded codec-backed payloads + handlers for additional high-impact intents:
      - `item_update` (slot index + item damage + page index, aligned to legacy packet shape)
      - `sync_entity_size` (entity id + width + height)
      - `set_client_player_facing` (yaw + pitch)
    - expanded codec-backed payloads + handlers for interaction intents:
      - `cam_pos` (active + updatePosition + entity id)
      - `push_target` (entity id + velocity vector)
      - `sound` (sound id + x/y/z + volume/pitch)
    - expanded codec-backed payloads + handlers for remaining utility intents:
      - `particles` (particle id + sound id + x/y/z + width/height + color)
      - `player_style` (username + grotesque/nightmare/ghost + creature type + blood + skin)
      - `spell_prepared` (effect id + level)
      - `sync_markup_book` (slot + pages list)
      - `clear_fall_damage` and `howl` now use explicit no-payload codec records + dedicated handlers.
    - clientbound packet handlers now include first functional client behavior:
      - `particles` now routes through a client packet bridge with legacy-aware `ParticleEffect`/`SoundEffect` id mapping, old-style effect count scaling, and colored spell particle support.
      - `player_sync`, `extended_player_sync`, and `partial_extended_player_sync` now apply incoming sync state on client with stale-revision guards and serialized `WitcheryPlayerData` snapshot hydration (plus mirrored persistent tags).
      - `player_style` now resolves target players client-side by username and applies staged style fields to capability + persistent tags.
      - `sound` now resolves and plays mapped client sounds (with legacy default volume/pitch behavior).
      - `push_target` now applies client-side motion vectors to the target entity.
      - `set_client_player_facing` now applies client-side player rotation.
      - `sync_entity_size` now stages synced width/height values on the client target entity for follow-up resize parity work.
      - `cam_pos` now follows legacy packet semantics (`active`, `updatePosition`, `entityId`) and stages camera-active/target state via explicit client camera state (`WitcheryClientCameraState`), with client tick hooks applying camera-entity overrides and reset fallback.
    - serverbound packet handlers now include first functional scaffold behavior:
      - `clear_fall_damage` now clears sender fall distance.
      - `item_update` now applies real inventory stack page mutation (`CurrentPage`) with legacy-style slot/damage validation.
      - `sync_markup_book` now applies real inventory stack page-list mutation (`pageStack` string list).
      - `spell_prepared`, `item_update`, `sync_markup_book`, and `howl` also stage state into `WitcheryPlayerData` (+ minimal persistent tags for spell/howl) and bump sync revision.
  - dimension migration skeleton now has stable resource-key anchors:
    - added `WitcheryDimensions` keys for `dream`, `torment`, and `mirror` across `Level`, `LevelStem`, and `DimensionType`.
    - added breadth-first datapack scaffold files for `dream`, `torment`, and `mirror` (`data/witchery/dimension_type/*.json` and `data/witchery/dimension/*.json`).
    - added runtime travel hook scaffold in `WitcheryDimensionTravelHooks` with route-resolution helpers and player routing entrypoint (`routePlayer`).
    - wired portal collision scaffold triggers through `PlayerTickEvent` -> `WitcheryDimensionTravelHooks.resolvePortalCollisionTrigger(...)` for `spiritportal` and `tormentportal` with cooldown gating.
    - narrowed right-click routing to mirror-rite scaffolds only (`mirrorblock*`, `mirrorwall`, `circleglyphotherwhere`) via `resolveRiteTriggerFromBlock(...)`.
    - rite-completion activation behavior and worldgen/provider tuning are still TODO.
  - event-bus hook skeleton now has explicit Forge-side anchor points:
    - added `WitcheryEventHooks` subscribers for entity capability attach, player login/clone, player tick, player right-click block, level load, entity travel-to-dimension, and player changed-dimension.
    - preserves breadth visibility for upcoming `ExtendedPlayer` replacement and world runtime bootstrap migration.
  - capability/data-attachment scaffold now exists for player data migration:
    - added `WitcheryCapabilities` MOD-bus registration for `WitcheryPlayerData`.
    - added `WitcheryPlayerDataProvider` attachment + clone-copy wiring through `WitcheryEventHooks`.
    - expanded `WitcheryPlayerData` NBT payload groups for legacy migration staging:
      - style/state: `creatureTypeOrdinal`, `humanBlood`, `grotesqueTicks`, `nightmareLevel`, `ghost`, `otherPlayerSkin`
      - effect state: `preparedSpellEffectId`, `preparedSpellLevel`
      - inventory/book staging: `lastItemUpdate*`, `lastMarkupBook*`
      - misc runtime staging: `lastHowlGameTime`
    - typed sync sends from event hooks:
      - login: `extended_player_sync` + `player_sync`
      - clone: `partial_extended_player_sync`
  - GUI/menu scaffold now has explicit legacy GUI-ID parity anchors:
    - migrated menu intent list from plain names to `(legacyGuiId, key)` metadata in `LegacyRegistryData`.
    - replaced generic `ChestMenu` placeholders with per-key `LegacyPlaceholderMenu` registrations.
    - added client-side `LegacyPlaceholderScreen` registration for every legacy menu type to keep all GUI IDs routable in 1.20.1.

## Phase Checklist

### Phase 0 - Discovery + Inventory (complete)
- [x] Map legacy startup lifecycle (`preInit/init/postInit/serverLoad`).
- [x] Enumerate legacy block registrations.
- [x] Enumerate legacy item registrations.
- [x] Enumerate fluid registrations and fluid-container bindings.
- [x] Enumerate entity registrations.
- [x] Enumerate high-impact registries (rites, brews, potions, predictions, creature powers, packets, dimensions, integrations).
- [x] Capture findings in manifest + memory docs.

### Phase 1 - 1.20 Registration Skeleton (breadth)
- [x] Create `DeferredRegister` structure for blocks.
- [x] Create `DeferredRegister` structure for items.
- [x] Create `DeferredRegister` structure for fluids + fluid types.
- [x] Create `DeferredRegister` structure for block entities.
- [x] Create `DeferredRegister` structure for entity types.
- [x] Create `DeferredRegister` structure for menu types.
- [x] Create `DeferredRegister` structure for mob effects (potions/effects).
- [x] Create creative mode tab wiring.
- [x] Register placeholder instances for every legacy registry entry (names first, behavior later).

### Phase 2 - Data + Assets Skeleton (breadth)
- [x] Add placeholder blockstates/models/lang entries for all registered blocks/items.
- [x] Add minimal data-gen providers (loot, recipes, tags).
  - `WitcheryBlockTagsProvider` (`legacy_blocks`), `WitcheryLootTableProvider`/`WitcheryBlockLoot` (self-drop scaffolding), and `WitcheryRecipeProvider` stub are registered via `WitcheryDataGenerators`.
- [x] Add placeholder spawn egg / bucket items where needed.
  - bucket scaffolding is wired for legacy fluid buckets (`bucketspirit`, `buckethollowtears`, `bucketbrew`).
  - placeholder spawn eggs are generated from legacy entity IDs using the `*_spawn_egg` naming pattern.
- [~] Ensure game boots with full registry surface present.
  - All static resource checks pass (no missing model parent/texture references).
  - Fresh client run verified: no Witchery model/texture bake errors after latest `icedoor`/`wolftrap` asset fixes.

### Phase 3 - Systems Migration Skeleton (breadth)
- [x] Network channel + packet stubs (all legacy packet message intents represented).
  - typed no-payload packet records are now registered for all `19` legacy intents.
  - codec-backed payload/handler scaffolding is now implemented for:
    - `player_sync`, `extended_player_sync`, `partial_extended_player_sync`
    - `item_update`, `sync_entity_size`, `set_client_player_facing`
    - `cam_pos`, `push_target`, `sound`
    - `particles`, `player_style`, `spell_prepared`, `sync_markup_book`
  - explicit no-payload codec records + handlers are now in place for:
    - `clear_fall_damage`, `howl`
  - serverbound handler scaffold now applies minimal runtime behavior:
    - clears fall distance for `clear_fall_damage`.
    - applies stack NBT mutations for item/book sync intents (`CurrentPage`, `pageStack`) and stages item/spell/book/howl updates into `WitcheryPlayerData`.
  - clientbound handler scaffold now applies minimal runtime behavior:
    - `particles` spawns local particles/sound via legacy-aware id mapping (`ParticleEffect`/`SoundEffect`) with effect-count scaling + colored spell support.
    - `player_sync`, `extended_player_sync`, and `partial_extended_player_sync` now hydrate staged client capability fields from serialized `WitcheryPlayerData` snapshots with stale-revision guards (plus persistent-tag mirrors for sync/style state).
    - `player_style` applies staged style sync to target player capability/persistent tags on client.
    - `sound`, `push_target`, `set_client_player_facing`, and `sync_entity_size` now route through client packet handlers with first-pass scaffold behavior.
    - `cam_pos` now routes through client packet handlers using `WitcheryClientCameraState` plus `WitcheryClientCameraHooks` (client tick camera-entity override scaffold) instead of temporary player persistent-tag staging.
- [~] GUI/menu stubs for all legacy GUI IDs.
  - menu intents now preserve legacy GUI ID mapping (`0..8`) plus key name in `LegacyRegistryData`.
  - all legacy menu keys now register typed `LegacyPlaceholderMenu` + `LegacyPlaceholderScreen` scaffolds.
  - opening behavior and real container slot logic are still TODO.
- [~] Dimension/key migration for Dream/Torment/Mirror.
  - resource keys are scaffolded (`Level`, `LevelStem`, `DimensionType`) for `dream`, `torment`, and `mirror`.
  - datapack `dimension_type` + `dimension` JSON scaffolding is now present for all three dimensions.
  - runtime travel scaffold hooks are in place via `WitcheryDimensionTravelHooks` + `WitcheryEventHooks`.
  - scaffold trigger routing is now split by trigger source:
    - portal collision path (`spiritportal`, `tormentportal`) via `PlayerTickEvent` + collision resolver.
    - right-click path (`mirrorblock*`, `mirrorwall`, `circleglyphotherwhere`) retained as temporary rite scaffold.
  - authentic rite-completion behavior and final provider behavior parity are still TODO.
- [~] Event bus hooks migrated with no-op or minimal behavior.
  - placeholder Forge-bus hooks are in place for attach-capabilities, player login/clone, player tick, player right-click block, entity travel-to-dimension, player changed-dimension, and level load events.
  - attach-capabilities/player-clone hooks now include capability provider wiring for player data scaffold.
  - real handler routing/feature logic is still TODO.
- [~] Capability/data attachment plan for replacing `ExtendedPlayer`/custom NBT patterns.
  - `WitcheryPlayerData` + provider + capability registration scaffolding is in place.
  - migration of legacy fields/logic from `ExtendedPlayer` remains TODO.

### Phase 4 - Feature Behavior Pass (depth)
- [ ] Blocks/tile entity behavior parity pass.
- [ ] Item behavior parity pass (including metadata-subitem conversions).
- [ ] Brewing/kettle/distillery/spinning/brazier parity.
- [ ] Ritual and circle magic parity.
- [ ] Infusion, prediction, creature power parity.
- [ ] Entity AI/combat/spawn tuning parity.

### Phase 5 - Integration + Stabilization
- [ ] Optional mod compat strategy (modern equivalents where relevant).
- [ ] Save migration / missing mapping strategy.
- [ ] Balance and progression validation.
- [ ] Multiplayer sync and desync hardening.
- [ ] Test matrix + release checklist.

## Immediate Next Actions
- [x] Add placeholder bucket/block hookups for fluids (if needed for world interaction/testing).
- [x] Add placeholder block items for non-itemized legacy blocks where useful for QA visibility.
  - `WitcheryItems.registerLegacyBlockItem(...)` now auto-registers block items for legacy block IDs that do not already map to dedicated item placeholders.
- [x] Re-run client and validate `run/logs/latest.log` after the lowercase resource-location fix.
- [x] Re-run client and validate `run/logs/latest.log` after `icedoor` parent-model and `wolftrap` geometry parity fixes.
- [~] Continue replacing placeholder block models with old 1.7 equivalents (breadth pass before behavior depth).
- [ ] Run targeted multiplayer/client validation for expanded player sync payload snapshots (`login`, `clone`, `item_update`, `spell_prepared`, `sync_markup_book`, `howl`).
  - completed crop-family stage model parity pass.
  - completed structural families (stairs/slabs/fence/fence-gate/pressure-plate/button) with 1.20.1 state models.
  - completed broad non-cube decorative/functional pass; remaining full-cube placeholders now narrowed to 14 likely-intentional cube blocks.
  - next breadth target: metadata/state parity for remaining multi-variant legacy cubes (`witchwood`, `witchleaves`, `wickerbundle`, `wallgen`) and orientation/state behavior where legacy used TESR/custom renderers.
- [ ] Keep this file updated as phases move from breadth to depth.
  - fixed plant-style solidity/culling mismatch (example: blood rose):
    - added non-occluding bounded block scaffolds for plant-like legacy blocks so they no longer behave as full cubes.
    - converted `bloodrose`, `glintweed`, `embermoss`, `crittersnare`, `plantmine` to `minecraft:block/cross` models.
    - moved `witchsapling` to a dedicated non-colliding variant block scaffold (`wood_type` still preserved).
  - added client render-layer registration (`cutout`/`cutoutMipped`/`translucent`) for transparent/cross assets to avoid opaque/full-block visual artifacts:
    - file: `/Users/cyberpwn/development/workspace/AuramMods/Witchery/src/main/java/art/arcane/witchery/client/WitcheryClient.java`
  - completed broad non-opaque shape parity pass for legacy decorative/special blocks:
    - extended `WitcheryBlocks` mapping to non-occluding/custom-shape scaffolds for high-impact IDs that were still default full cubes (`demonheart`, `wolfhead`, `alluringskull`, `chalice`, `candelabra`, `brazier`, `crystalball`, `placeditem`, `garlicgarland`, `dreamcatcher`, `poppetshelf`, `silvervat`, `daylightcollector`, `bloodcrucible`, `mirrorblock*`, `circle*`, `beartrap`, `wolftrap`, plus fluid/portal placeholders).
    - added shape-aware horizontal scaffold support for machine/chest-style blocks so existing `facing` blockstates now use non-full bounding where legacy blocks were not full cubes.
    - mapped `stockade` and `icestockade` to fence behavior scaffold for breadth parity with legacy post/connection behavior.
  - expanded client render-layer coverage to include additional alpha-heavy decorative blocks and portal/fluid-style placeholders (cutout + translucent groups).
  - migrated legacy fluid-like block IDs to true fluid scaffolds:
    - `spiritflowing`, `hollowtears`, `disease`, `brew`, `brewgas`, `brewliquid` now use `LiquidBlock` tied to `WitcheryFluids` source fluids.
    - bucket items `bucketspirit`, `buckethollowtears`, `bucketbrew` now register as `BucketItem` instead of generic items.
  - upgraded GUI placeholder surface to legacy-ID aware menu/screen scaffolds:
    - `WitcheryMenus` now registers `LegacyPlaceholderMenu` entries keyed from `LegacyRegistryData.LegacyMenuIntent`.
    - `WitcheryClient` now registers `LegacyPlaceholderScreen` for all menu placeholders.
    - this keeps every legacy GUI ID wired while container/screen behavior is still breadth-level placeholder logic.
  - look-ahead queue for next operations:
    - replace remaining temporary mirror right-click routing with rite-completion activation hooks.
    - harden camera override lifecycle in `WitcheryClientCameraHooks` for edge cases (dimension swap, target despawn timeout, spectator transitions).
    - extend client sync handling beyond revision/initialized to include fuller staged groups as payload coverage grows (style/inventory/spell slices).
    - expand `WitcheryPlayerData` fields toward legacy `ExtendedPlayer` coverage (inventory/state/effect sync groups).
  - validation: `./gradlew compileJava` succeeds after this pass.
